<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assistant T√¢ches Said</title>
    <style>
        body { font-family: sans-serif; display: flex; justify-content: center; align-items: center; min-height: 100vh; background-color: #f0f2f5; margin: 0; }
        .container { text-align: center; background: white; padding: 40px; border-radius: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 90%; max-width: 500px; }
        
        h2 { color: #333; margin-bottom: 5px; }
        p { color: #666; margin-bottom: 20px; font-weight: bold; font-size: 14px; }
        
        select {
            width: 100%;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 10px;
            border: 1px solid #ccc;
            font-size: 16px;
            background-color: #f9f9f9;
        }

        .btn-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        button { 
            color: white; 
            border: none; 
            padding: 15px 30px; 
            font-size: 18px; 
            border-radius: 50px; 
            cursor: pointer; 
            width: 100%; 
            transition: transform 0.1s;
            font-weight: bold;
        }

        button:active { transform: scale(0.98); }

        .btn-start { background-color: #007bff; }
        .btn-pause { background-color: #ffc107; color: #333; }
        .btn-resume { background-color: #28a745; }
        .btn-stop { background-color: #dc3545; }

        .controls {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        #status { margin-top: 25px; color: #666; font-style: italic; min-height: 20px;}
    </style>
</head>
<body>

<div class="container">
    <h2>Bonjour Monsieur Said</h2>
    <p>Version 4 (Choix de la voix)</p>
    
    <!-- MENU POUR CHOISIR LA VOIX -->
    <label for="choixVoix" style="display:block; text-align:left; margin-bottom:5px; color:#555;">Choisissez la voix :</label>
    <select id="choixVoix">
        <option value="">Chargement des voix...</option>
    </select>

    <div class="btn-group">
        <button class="btn-start" onclick="lireTaches()">üîä √âcouter mes t√¢ches</button>
        
        <div class="controls">
            <button class="btn-pause" onclick="pauseLecture()">‚è∏ Pause</button>
            <button class="btn-resume" onclick="reprendreLecture()">‚ñ∂ Reprendre</button>
            <button class="btn-stop" onclick="stopLecture()">‚èπ Stop</button>
        </div>
    </div>

    <div id="status">En attente...</div>
</div>

<script>
    // ‚ö†Ô∏è‚ö†Ô∏è COLLEZ VOTRE URL GOOGLE APPS SCRIPT ICI ‚ö†Ô∏è‚ö†Ô∏è
    const API_URL = "https://script.google.com/macros/s/AKfycbywj5xDRRDIdjK7rXFn7iz90o5MXImzwEIpjXxu2J4bQFNXqoVAgHpFxJjw2Int4sn-/exec"; 

    const synthese = window.speechSynthesis;
    let phraseEnCours = null;
    let voixDisponibles = [];
    const selectVoix = document.getElementById('choixVoix');

    // --- 1. CHARGEMENT ET AFFICHAGE DES VOIX ---
    function chargerEtAfficherVoix() {
        voixDisponibles = synthese.getVoices();
        
        // On vide le menu
        selectVoix.innerHTML = '';

        // On ne garde que les voix qui ont "fr" dans la langue
        const voixFr = voixDisponibles.filter(voice => voice.lang.includes('fr') || voice.lang.includes('FR'));

        if (voixFr.length === 0) {
            let option = document.createElement('option');
            option.text = "Aucune voix fran√ßaise trouv√©e";
            selectVoix.add(option);
            return;
        }

        // On ajoute chaque voix au menu
        voixFr.forEach((voice, index) => {
            let option = document.createElement('option');
            option.value = index; // On stocke l'index pour retrouver la voix plus tard
            // On affiche le nom de la voix (ex: Thomas, Google Fran√ßais...)
            option.text = voice.name + ' (' + voice.lang + ')';
            selectVoix.add(option);

            // AUTO-SELECTION : On essaie de s√©lectionner fr-FR par d√©faut (et √©viter Canada)
            if (voice.lang === 'fr-FR' && !voice.name.includes('Canada')) {
                selectVoix.selectedIndex = index;
            }
        });
    }

    // Chargement des voix (certains navigateurs sont lents √† les donner)
    chargerEtAfficherVoix();
    if (speechSynthesis.onvoiceschanged !== undefined) {
        speechSynthesis.onvoiceschanged = chargerEtAfficherVoix;
    }

    async function lireTaches() {
        const statusDiv = document.getElementById('status');
        stopLecture();
        
        // Astuce iPhone
        const unlock = new SpeechSynthesisUtterance('');
        synthese.speak(unlock);

        statusDiv.innerText = "R√©cup√©ration des t√¢ches...";
        
        try {
            const response = await fetch(API_URL);
            const data = await response.json();
            
            let texteALire = data.intro;
            
            if (data.taches.length === 0) {
                texteALire += " Vous n'avez aucune t√¢che en attente pour aujourd'hui. Profitez-en !";
            } else {
                data.taches.forEach((tache, index) => {
                    texteALire += " T√¢che num√©ro " + (index + 1) + " : " + tache + ", ";
                });
                texteALire += " Fin de la liste. Bonne journ√©e !";
            }

            statusDiv.innerText = "Lecture en cours...";
            parler(texteALire);

        } catch (error) {
            console.error(error);
            statusDiv.innerText = "Erreur de connexion.";
        }
    }

    function parler(texte) {
        synthese.cancel();

        phraseEnCours = new SpeechSynthesisUtterance(texte);
        
        // --- 2. APPLIQUER LA VOIX CHOISIE DANS LE MENU ---
        const selectedOption = selectVoix.selectedOptions[0];
        // On retrouve la vraie voix dans la liste filtr√©e gr√¢ce au nom
        const nomChoisi = selectedOption.text;
        
        // On cherche l'objet voix correspondant dans la liste compl√®te
        const voixChoisie = voixDisponibles.find(v => (v.name + ' (' + v.lang + ')') === nomChoisi);

        if (voixChoisie) {
            phraseEnCours.voice = voixChoisie;
            phraseEnCours.lang = voixChoisie.lang;
        }
        // ------------------------------------------------

        phraseEnCours.rate = 1; 
        phraseEnCours.pitch = 1;
        
        phraseEnCours.onend = function() {
            document.getElementById('status').innerText = "Lecture termin√©e.";
        };

        synthese.speak(phraseEnCours);
    }

    function pauseLecture() {
        if (synthese.speaking && !synthese.paused) {
            synthese.pause();
            document.getElementById('status').innerText = "Lecture en pause...";
        }
    }

    function reprendreLecture() {
        if (synthese.paused) {
            synthese.resume();
            document.getElementById('status').innerText = "Lecture en cours...";
        }
    }

    function stopLecture() {
        synthese.cancel();
        document.getElementById('status').innerText = "Lecture arr√™t√©e.";
    }
</script>

</body>
</html>
